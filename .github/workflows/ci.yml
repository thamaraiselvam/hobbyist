name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  prechecks:
    name: Pre-checks (Analyze & Format)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.41.1'
          channel: 'stable'
          cache: true
          cache-key: flutter-${{ runner.os }}-${{ hashFiles('**/pubspec.lock') }}

      - name: Cache pub dependencies
        uses: actions/cache@v4
        with:
          path: ~/.pub-cache
          key: pub-${{ runner.os }}-${{ hashFiles('**/pubspec.lock') }}
          restore-keys: pub-${{ runner.os }}-

      - name: Install dependencies
        run: flutter pub get

      - name: Run Flutter Analyze
        run: flutter analyze --no-pub

      - name: Check Dart formatting
        run: dart format --set-exit-if-changed .

  security-checks:
    name: Security Checks
    runs-on: ubuntu-latest
    needs: prechecks
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.41.1'
          channel: 'stable'
          cache: true
          cache-key: flutter-${{ runner.os }}-${{ hashFiles('**/pubspec.lock') }}

      - name: Cache pub dependencies
        uses: actions/cache@v4
        with:
          path: ~/.pub-cache
          key: pub-${{ runner.os }}-${{ hashFiles('**/pubspec.lock') }}
          restore-keys: pub-${{ runner.os }}-

      - name: Install dependencies
        run: flutter pub get

      - name: Run dependency audit
        run: |
          echo "Checking for known vulnerabilities in dependencies..."
          flutter pub outdated --json > outdated.json || true
          cat outdated.json

      - name: Check for secrets in code
        run: |
          echo "Scanning for potential secrets..."
          # Check for common secret patterns
          ! grep -r "api[_-]key\s*=\s*['\"][a-zA-Z0-9]\+" lib/ || (echo "Potential API key found!" && exit 1)
          ! grep -r "password\s*=\s*['\"][^'\"]\+" lib/ || (echo "Potential password found!" && exit 1)
          echo "No obvious secrets found."

      - name: Check for TODO security issues
        run: |
          echo "Checking for security-related TODOs..."
          grep -r "TODO.*security\|FIXME.*security\|XXX.*security" . || echo "No security TODOs found."

  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: prechecks
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.41.1'
          channel: 'stable'
          cache: true
          cache-key: flutter-${{ runner.os }}-${{ hashFiles('**/pubspec.lock') }}

      - name: Cache pub dependencies
        uses: actions/cache@v4
        with:
          path: ~/.pub-cache
          key: pub-${{ runner.os }}-${{ hashFiles('**/pubspec.lock') }}
          restore-keys: pub-${{ runner.os }}-

      - name: Install dependencies
        run: flutter pub get

      - name: Run unit tests
        run: flutter test test/unit/ --coverage --concurrency=4

      - name: Run widget tests
        run: flutter test test/widget/ --coverage --concurrency=4

      - name: Generate coverage report
        run: |
          flutter pub global activate coverage
          flutter pub global run coverage:format_coverage --lcov --in=coverage --out=coverage/lcov.info --report-on=lib

      - name: Upload coverage to artifacts
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage/
          retention-days: 30

  build-android:
    name: Build Android APK
    runs-on: ubuntu-latest
    needs: [security-checks, unit-tests]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'
          cache: 'gradle'

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.41.1'
          channel: 'stable'
          cache: true
          cache-key: flutter-${{ runner.os }}-${{ hashFiles('**/pubspec.lock') }}

      - name: Cache Gradle dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: gradle-${{ runner.os }}-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: gradle-${{ runner.os }}-

      - name: Cache pub dependencies
        uses: actions/cache@v4
        with:
          path: ~/.pub-cache
          key: pub-${{ runner.os }}-${{ hashFiles('**/pubspec.lock') }}
          restore-keys: pub-${{ runner.os }}-

      # google-services.json is gitignored. Write a placeholder so the Gradle
      # google-services plugin is satisfied at build time. Firebase will fail to
      # initialise at runtime, but the app handles this gracefully via try/catch
      # in main.dart and AuthService. Core hobby tracking (SQLite) works fine.
      # For a production release, replace this with a secret-injected real file.
      - name: Create placeholder google-services.json
        run: |
          cat > android/app/google-services.json << 'EOF'
          {
            "project_info": {
              "project_number": "000000000000",
              "project_id": "placeholder-project",
              "storage_bucket": "placeholder-project.appspot.com"
            },
            "client": [
              {
                "client_info": {
                  "mobilesdk_app_id": "1:000000000000:android:0000000000000000",
                  "android_client_info": {
                    "package_name": "tham.hobbyist.app"
                  }
                },
                "oauth_client": [],
                "api_key": [{ "current_key": "placeholder_api_key" }],
                "services": {
                  "appinvite_service": { "other_platform_oauth_client": [] }
                }
              }
            ],
            "configuration_version": "1"
          }
          EOF

      - name: Install dependencies
        run: flutter pub get

      - name: Build debug APK
        run: flutter build apk --debug --no-pub

      - name: Build release APK
        run: flutter build apk --release --no-pub

      - name: Rename APKs
        run: |
          mv build/app/outputs/flutter-apk/app-debug.apk build/app/outputs/flutter-apk/hobbyist-debug.apk
          mv build/app/outputs/flutter-apk/app-release.apk build/app/outputs/flutter-apk/hobbyist-release.apk

      - name: Upload debug APK
        uses: actions/upload-artifact@v4
        with:
          name: hobbyist-debug-apk
          path: build/app/outputs/flutter-apk/hobbyist-debug.apk
          retention-days: 30

      - name: Upload release APK
        uses: actions/upload-artifact@v4
        with:
          name: hobbyist-release-apk
          path: build/app/outputs/flutter-apk/hobbyist-release.apk
          retention-days: 30

      - name: Get APK info
        run: |
          ls -lh build/app/outputs/flutter-apk/
          echo "âœ… Android APK builds completed successfully!"
          echo "ðŸ“¦ Download the artifacts from the Actions tab."

  maestro-e2e:
    name: Maestro E2E Tests
    runs-on: ubuntu-latest
    needs: build-android
    # Skip on PRs â€” E2E adds ~15 min and emulator flakiness shouldn't gate fast
    # PR feedback. Runs on push to main/develop (regression guard) and on
    # workflow_dispatch (manual trigger for debugging).
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    # Non-blocking while the suite stabilises in CI. Remove continue-on-error
    # once the failure rate has been consistently low over a few weeks of runs.
    continue-on-error: true
    timeout-minutes: 25
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # GitHub Actions ubuntu-latest runners support KVM since Jan 2024.
      # This udev rule grants the runner user rw access to /dev/kvm, which
      # reactivecircus/android-emulator-runner requires for hardware acceleration.
      - name: Enable KVM
        run: |
          echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
          sudo udevadm control --reload-rules
          sudo udevadm trigger --name-match=kvm

      # JDK is needed for: (1) `jar xf` to extract Maestro driver APKs from
      # maestro-client.jar, and (2) the Maestro CLI runtime itself (JVM-based).
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: Download debug APK
        uses: actions/download-artifact@v4
        with:
          name: hobbyist-debug-apk
          path: build/

      - name: Install Maestro CLI
        run: |
          curl -fsSL "https://get.maestro.mobile.dev" | bash
          echo "$HOME/.maestro/bin" >> $GITHUB_PATH

      # Cache the AVD to avoid a full 3-5 min emulator creation on each run.
      # Key is stable per API level + arch + OS. Delete via GH Actions cache UI
      # if the snapshot becomes stale or corrupted.
      - name: AVD cache
        uses: actions/cache@v4
        id: avd-cache
        with:
          path: |
            ~/.android/avd/*
            ~/.android/adb*
          key: avd-34-google_apis-x86_64-${{ runner.os }}

      # On cache miss: boot the emulator once to create and persist the snapshot.
      # Subsequent runs restore from cache and skip this step entirely.
      - name: Create AVD snapshot (cache miss only)
        if: steps.avd-cache.outputs.cache-hit != 'true'
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 34
          target: google_apis
          arch: x86_64
          profile: Nexus 6
          force-avd-creation: false
          emulator-options: -no-window -gpu swiftshader_indirect -noaudio -no-boot-anim
          disable-animations: true
          script: echo "AVD snapshot created for caching"

      - name: Run Maestro E2E suite
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 34
          # google_apis image required â€” Firebase services need Google Play Services,
          # which are absent from AOSP (default) images. API 34 is also required
          # because POST_NOTIFICATIONS is a runtime permission only on API 33+.
          target: google_apis
          arch: x86_64
          profile: Nexus 6
          force-avd-creation: false
          # -no-snapshot-save: don't overwrite the cached AVD snapshot each run.
          emulator-options: -no-snapshot-save -no-window -gpu swiftshader_indirect -noaudio -no-boot-anim
          disable-animations: true
          emulator-boot-timeout: 300
          script: |
            # Install the Hobbyist app APK
            adb install -r build/hobbyist-debug.apk

            # â”€â”€ Maestro driver setup â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            # The standard `launchApp` command crashes on Maestro 2.1.0 due to a
            # TcpForwarder/port-7001 bug. Workaround: extract the driver APKs from
            # the bundled JAR, side-load them, and forward port 7001 manually.
            # All 10 YAML flows avoid `launchApp`; app lifecycle is ADB-only.
            # See: run_tests.sh and CLAUDE.md â†’ "Known issues and rules".
            # Note: script runs under /usr/bin/sh (dash); pushd/popd are bash-only.
            # Use a fixed dir + full paths to avoid variable-persistence issues.
            mkdir -p /tmp/maestro-driver
            cd /tmp/maestro-driver && jar xf "$HOME/.maestro/lib/maestro-client.jar" maestro-app.apk maestro-server.apk
            adb install -r /tmp/maestro-driver/maestro-app.apk
            adb install -r /tmp/maestro-driver/maestro-server.apk

            # Start the on-device gRPC server and expose it to the host Maestro CLI.
            adb shell am instrument -w dev.mobile.maestro.test/androidx.test.runner.AndroidJUnitRunner &
            adb forward tcp:7001 tcp:7001
            sleep 3

            # Pre-suite setup: fresh app state + pre-grant notification permission
            # so the OS dialog never appears mid-test. POST_NOTIFICATIONS became a
            # runtime permission in API 33; must be granted before the app starts.
            adb shell pm clear tham.hobbyist.app
            adb shell pm grant tham.hobbyist.app android.permission.POST_NOTIFICATIONS
            adb shell am start -n tham.hobbyist.app/.MainActivity
            sleep 3

            # Run the full 10-flow ordered test suite
            maestro test maestro-tests/suite.yml

      # Upload results even on failure so flaky runs can be diagnosed.
      # The job is non-blocking (continue-on-error: true) so this always fires.
      - name: Upload Maestro test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: maestro-e2e-results
          path: ~/.maestro/tests/
          retention-days: 14
          if-no-files-found: ignore

  summary:
    name: Build Summary
    runs-on: ubuntu-latest
    needs: [prechecks, security-checks, unit-tests, build-android, maestro-e2e]
    if: always()
    steps:
      - name: Check job statuses
        run: |
          echo "## ðŸŽ¯ CI/CD Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Pre-checks | ${{ needs.prechecks.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Security Checks | ${{ needs.security-checks.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Unit Tests | ${{ needs.unit-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Android Build | ${{ needs.build-android.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Maestro E2E | ${{ needs.maestro-e2e.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ Download Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "- Debug APK: Available in artifacts" >> $GITHUB_STEP_SUMMARY
          echo "- Release APK: Available in artifacts" >> $GITHUB_STEP_SUMMARY
          echo "- Coverage Report: Available in artifacts" >> $GITHUB_STEP_SUMMARY
          echo "- E2E Results: Available in artifacts (push/dispatch runs only)" >> $GITHUB_STEP_SUMMARY
