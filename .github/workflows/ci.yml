name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  prechecks:
    name: Pre-checks (Analyze & Format)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.0'
          channel: 'stable'
          cache: true

      - name: Install dependencies
        run: flutter pub get

      - name: Verify Flutter installation
        run: flutter doctor -v

      - name: Run Flutter Analyze
        run: flutter analyze --no-pub

      - name: Check Dart formatting
        run: dart format --set-exit-if-changed .

  security-checks:
    name: Security Checks
    runs-on: ubuntu-latest
    needs: prechecks
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.0'
          channel: 'stable'
          cache: true

      - name: Install dependencies
        run: flutter pub get

      - name: Run dependency audit
        run: |
          echo "Checking for known vulnerabilities in dependencies..."
          flutter pub outdated --json > outdated.json || true
          cat outdated.json

      - name: Check for secrets in code
        run: |
          echo "Scanning for potential secrets..."
          # Check for common secret patterns
          ! grep -r "api[_-]key\s*=\s*['\"][a-zA-Z0-9]\+" lib/ || (echo "Potential API key found!" && exit 1)
          ! grep -r "password\s*=\s*['\"][^'\"]\+" lib/ || (echo "Potential password found!" && exit 1)
          echo "No obvious secrets found."

      - name: Check for TODO security issues
        run: |
          echo "Checking for security-related TODOs..."
          grep -r "TODO.*security\|FIXME.*security\|XXX.*security" . || echo "No security TODOs found."

  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: prechecks
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.0'
          channel: 'stable'
          cache: true

      - name: Install dependencies
        run: flutter pub get

      - name: Run unit tests
        run: flutter test test/unit/ --coverage --concurrency=1

      - name: Run widget tests
        run: flutter test test/widget/ --coverage --concurrency=1

      - name: Generate coverage report
        run: |
          flutter pub global activate coverage
          flutter pub global run coverage:format_coverage --lcov --in=coverage --out=coverage/lcov.info --report-on=lib

      - name: Upload coverage to artifacts
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage/
          retention-days: 30

  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: unit-tests
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.0'
          channel: 'stable'
          cache: true

      - name: Install dependencies
        run: flutter pub get

      - name: Build integration test APK
        run: flutter build apk --debug --target=integration_test/app_test.dart

      - name: Note about integration tests
        run: |
          echo "âš ï¸  Integration tests require an emulator or physical device."
          echo "Skipping actual test execution in CI. Run locally with:"
          echo "flutter test integration_test/"

  build-android:
    name: Build Android APK
    runs-on: ubuntu-latest
    needs: [security-checks, unit-tests]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'
          cache: 'gradle'

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.0'
          channel: 'stable'
          cache: true

      - name: Install dependencies
        run: flutter pub get

      - name: Build debug APK
        run: flutter build apk --debug

      - name: Build release APK
        run: flutter build apk --release

      - name: Rename APKs
        run: |
          mv build/app/outputs/flutter-apk/app-debug.apk build/app/outputs/flutter-apk/hobbyist-debug.apk
          mv build/app/outputs/flutter-apk/app-release.apk build/app/outputs/flutter-apk/hobbyist-release.apk

      - name: Upload debug APK
        uses: actions/upload-artifact@v4
        with:
          name: hobbyist-debug-apk
          path: build/app/outputs/flutter-apk/hobbyist-debug.apk
          retention-days: 30

      - name: Upload release APK
        uses: actions/upload-artifact@v4
        with:
          name: hobbyist-release-apk
          path: build/app/outputs/flutter-apk/hobbyist-release.apk
          retention-days: 30

      - name: Get APK info
        run: |
          ls -lh build/app/outputs/flutter-apk/
          echo "âœ… Android APK builds completed successfully!"
          echo "ðŸ“¦ Download the artifacts from the Actions tab."

  # iOS build - disabled for now
  # Uncomment and configure when ready to build iOS
  # build-ios:
  #   name: Build iOS IPA
  #   runs-on: macos-latest
  #   needs: [security-checks, unit-tests]
  #   if: false  # Disabled - set to true when ready
  #   steps:
  #     - name: Checkout code
  #       uses: actions/checkout@v4
  #
  #     - name: Setup Flutter
  #       uses: subosito/flutter-action@v2
  #       with:
  #         flutter-version: '3.24.0'
  #         channel: 'stable'
  #         cache: true
  #
  #     - name: Install dependencies
  #       run: flutter pub get
  #
  #     - name: Setup Xcode
  #       uses: maxim-lobanov/setup-xcode@v1
  #       with:
  #         xcode-version: latest-stable
  #
  #     - name: Install CocoaPods
  #       run: |
  #         cd ios
  #         pod install
  #
  #     - name: Build iOS (no codesign)
  #       run: flutter build ios --release --no-codesign
  #
  #     - name: Create IPA
  #       run: |
  #         cd build/ios/iphoneos
  #         mkdir Payload
  #         cp -r Runner.app Payload/
  #         zip -r hobbyist-release.ipa Payload/
  #
  #     - name: Upload IPA
  #       uses: actions/upload-artifact@v4
  #       with:
  #         name: hobbyist-ios-ipa
  #         path: build/ios/iphoneos/hobbyist-release.ipa
  #         retention-days: 30

  summary:
    name: Build Summary
    runs-on: ubuntu-latest
    needs: [prechecks, security-checks, unit-tests, integration-tests, build-android]
    if: always()
    steps:
      - name: Check job statuses
        run: |
          echo "## ðŸŽ¯ CI/CD Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Pre-checks | ${{ needs.prechecks.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Security Checks | ${{ needs.security-checks.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Unit Tests | ${{ needs.unit-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Integration Tests | ${{ needs.integration-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Android Build | ${{ needs.build-android.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ Download Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "- Debug APK: Available in artifacts" >> $GITHUB_STEP_SUMMARY
          echo "- Release APK: Available in artifacts" >> $GITHUB_STEP_SUMMARY
          echo "- Coverage Report: Available in artifacts" >> $GITHUB_STEP_SUMMARY
